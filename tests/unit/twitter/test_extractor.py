import unittest
from twitter.domain.tweet import Tweet
from twitter.domain.account import Account
from twitter.client.parser import Parser
from faker import Faker

tweet_template = "<li class=\"js-stream-item stream-item stream-item \" data-item-id=\"1060774952335491072\" id=\"stream-item-tweet-1060774952335491072\" data-item-type=\"tweet\" > <div class=\"tweet js-stream-tweet js-actionable-tweet js-profile-popup-actionable dismissible-content original-tweet js-original-tweet has-cards has-content \" data-tweet-id=\"1060774952335491072\" data-item-id=\"1060774952335491072\" data-permalink-path=\"/AJBenzStorm/status/1060774952335491072\" data-conversation-id=\"1060774952335491072\" data-tweet-nonce=\"1060774952335491072-366a628a-b904-4a9b-92bc-62f7c03ff190\" data-tweet-stat-initialized=\"true\" data-screen-name=\"AJBenzStorm\" data-name=\"AJ Benz ðŸŒ© ðŸ³ï¸â€ðŸŒˆ ðŸ‡¬ðŸ‡§ðŸ‡®ðŸ‡ªðŸ‡®ðŸ‡¹\" data-user-id=\"912192263903760384\" data-you-follow=\"false\" data-follows-you=\"false\" data-you-block=\"false\" data-reply-to-users-json=\"[{{&quot;id_str&quot;:&quot;912192263903760384&quot;,&quot;screen_name&quot;:&quot;AJBenzStorm&quot;,&quot;name&quot;:&quot;AJ Benz \ud83c\udf29 \ud83c\udff3\ufe0f\u200d\ud83c\udf08 \ud83c\uddec\ud83c\udde7\ud83c\uddee\ud83c\uddea\ud83c\uddee\ud83c\uddf9&quot;,&quot;emojified_name&quot;:{{&quot;text&quot;:&quot;AJ Benz \ud83c\udf29 \ud83c\udff3\ufe0f\u200d\ud83c\udf08 \ud83c\uddec\ud83c\udde7\ud83c\uddee\ud83c\uddea\ud83c\uddee\ud83c\uddf9&quot;,&quot;emojified_text_as_html&quot;:&quot;AJ Benz \u003cspan class=\&quot;Emoji Emoji--forLinks\&quot; style=\&quot;background-image:url(&#39;https:\/\/abs.twimg.com\/emoji\/v2\/72x72\/1f329.png&#39;)\&quot; title=\&quot;Cloud with lightning\&quot; aria-label=\&quot;Emoji: Cloud with lightning\&quot;\u003e&amp;nbsp;\u003c\/span\u003e\u003cspan class=\&quot;visuallyhidden\&quot; aria-hidden=\&quot;true\&quot;\u003e\ud83c\udf29\u003c\/span\u003e \u003cspan class=\&quot;Emoji Emoji--forLinks\&quot; style=\&quot;background-image:url(&#39;https:\/\/abs.twimg.com\/emoji\/v2\/72x72\/1f3f3-fe0f-200d-1f308.png&#39;)\&quot; title=\&quot;Rainbow flag\&quot; aria-label=\&quot;Emoji: Rainbow flag\&quot;\u003e&amp;nbsp;\u003c\/span\u003e\u003cspan class=\&quot;visuallyhidden\&quot; aria-hidden=\&quot;true\&quot;\u003e\ud83c\udff3\ufe0f\u200d\ud83c\udf08\u003c\/span\u003e \u003cspan class=\&quot;Emoji Emoji--forLinks\&quot; style=\&quot;background-image:url(&#39;https:\/\/abs.twimg.com\/emoji\/v2\/72x72\/1f1ec-1f1e7.png&#39;)\&quot; title=\&quot;Flag of United Kingdom\&quot; aria-label=\&quot;Emoji: Flag of United Kingdom\&quot;\u003e&amp;nbsp;\u003c\/span\u003e\u003cspan class=\&quot;visuallyhidden\&quot; aria-hidden=\&quot;true\&quot;\u003e\ud83c\uddec\ud83c\udde7\u003c\/span\u003e\u003cspan class=\&quot;Emoji Emoji--forLinks\&quot; style=\&quot;background-image:url(&#39;https:\/\/abs.twimg.com\/emoji\/v2\/72x72\/1f1ee-1f1ea.png&#39;)\&quot; title=\&quot;Flag of Ireland\&quot; aria-label=\&quot;Emoji: Flag of Ireland\&quot;\u003e&amp;nbsp;\u003c\/span\u003e\u003cspan class=\&quot;visuallyhidden\&quot; aria-hidden=\&quot;true\&quot;\u003e\ud83c\uddee\ud83c\uddea\u003c\/span\u003e\u003cspan class=\&quot;Emoji Emoji--forLinks\&quot; style=\&quot;background-image:url(&#39;https:\/\/abs.twimg.com\/emoji\/v2\/72x72\/1f1ee-1f1f9.png&#39;)\&quot; title=\&quot;Flag of Italy\&quot; aria-label=\&quot;Emoji: Flag of Italy\&quot;\u003e&amp;nbsp;\u003c\/span\u003e\u003cspan class=\&quot;visuallyhidden\&quot; aria-hidden=\&quot;true\&quot;\u003e\ud83c\uddee\ud83c\uddf9\u003c\/span\u003e&quot;}}}}]\" data-disclosure-type=\"\" data-has-cards=\"true\" data-component-context=\"tweet\" > <div class=\"context\"> </div> <div class=\"content\"> <div class=\"stream-item-header\"> <a class=\"account-group js-account-group js-action-profile js-user-profile-link js-nav\" href=\"{account[href]}\" data-user-id=\"{account[id]}\"> <img class=\"avatar js-action-profile-avatar\" src=\"https://pbs.twimg.com/profile_images/1035805630651658240/qszg1MQQ_bigger.jpg\" alt=\"\"> <span class=\"FullNameGroup\"> <strong class=\"fullname show-popup-with-id u-textTruncate \" data-aria-label-part>{account[fullname]}</strong><span>&rlm;</span><span class=\"UserBadges\"></span><span class=\"UserNameBreak\">&nbsp;</span></span><span class=\"username u-dir u-textTruncate\" dir=\"ltr\" data-aria-label-part>@<b>AJBenzStorm</b></span></a> <small class=\"time\"> <a href=\"/AJBenzStorm/status/1060774952335491072\" class=\"tweet-timestamp js-permalink js-nav js-tooltip\" title=\"10:03 PM - 8 Nov 2018\" data-conversation-id=\"1060774952335491072\"><span class=\"_timestamp js-short-timestamp js-relative-timestamp\" data-time=\"1541743431\" data-time-ms=\"1541743431000\" data-long-form=\"true\" aria-hidden=\"true\">4h</span><span class=\"u-hiddenVisually\" data-aria-label-part=\"last\">4 hours ago</span></a> </small> <div class=\"ProfileTweet-action ProfileTweet-action--more js-more-ProfileTweet-actions\"> <div class=\"dropdown\"> <button class=\"ProfileTweet-actionButton u-textUserColorHover dropdown-toggle js-dropdown-toggle\" type=\"button\"> <div class=\"IconContainer js-tooltip\" title=\"More\"> <span class=\"Icon Icon--caretDownLight Icon--small\"></span> <span class=\"u-hiddenVisually\">More</span> </div> </button> <div class=\"dropdown-menu is-autoCentered\"> <div class=\"dropdown-caret\"> <div class=\"caret-outer\"></div> <div class=\"caret-inner\"></div> </div> <ul> <li class=\"copy-link-to-tweet js-actionCopyLinkToTweet\"> <button type=\"button\" class=\"dropdown-link\">Copy link to tweetrepo</button> </li> <li class=\"embed-link js-actionEmbedTweet\" data-nav=\"embed_tweet\"> <button type=\"button\" class=\"dropdown-link\">Embed tweetrepo</button> </li> </ul> </div> </div> </div> </div> <div class=\"js-tweet-text-container\"><p class=\"TweetTextSize js-tweet-text tweet-text\" lang=\"en\" data-aria-label-part=\"0\">mr robot Yes Thanks <a href=\"/hashtag/PrimeVideo?src=hash\" data-query-source=\"hashtag_click\" class=\"twitter-hashtag pretty-link js-nav\" dir=\"ltr\"><s>#</s><b>PrimeVideo</b></a> <a href=\"/hashtag/Amazon?src=hash\" data-query-source=\"hashtag_click\" class=\"twitter-hashtag pretty-link js-nav\" dir=\"ltr\"><s>#</s><b><strong>Amazon</strong></b></a> <a href=\"/hashtag/thatsgenius?src=hash\" data-query-source=\"hashtag_click\" class=\"twitter-hashtag pretty-link js-nav\" dir=\"ltr\"><s>#</s><b>thatsgenius</b></a><a href=\"https://t.co/sDqLNZDPNY\" class=\"twitter-timeline-link u-hidden\" data-pre-embedded=\"true\" dir=\"ltr\">pic.twitter.com/sDqLNZDPNY</a></p> </div> <div class=\"AdaptiveMediaOuterContainer\"> <div class=\"AdaptiveMedia is-square \" > <div class=\"AdaptiveMedia-container\"> <div class=\"AdaptiveMedia-singlePhoto\" style=\"padding-top: calc(1.775 * 100% - 0.5px);\" > <div class=\"AdaptiveMedia-photoContainer js-adaptive-photo \" data-image-url=\"https://pbs.twimg.com/media/DrihKl2WkAE7qtu.jpg\" data-element-context=\"platform_photo_card\" style=\"background-color:rgba(52,63,64,1.0);\" data-dominant-color=\"[52,63,64]\" > <img data-aria-label-part src=\"https://pbs.twimg.com/media/DrihKl2WkAE7qtu.jpg\" alt=\"\" style=\"width: 100%; top: -23px;\" > </div> </div> </div> </div> </div> <div class=\"stream-item-footer\"> <div class=\"ProfileTweet-actionCountList u-hiddenVisually\"> <span class=\"ProfileTweet-action--reply u-hiddenVisually\"> <span class=\"ProfileTweet-actionCount\" data-tweet-stat-count=\"{replies}\"> <span class=\"ProfileTweet-actionCountForAria\" id=\"profile-tweet-action-reply-count-aria-1060774952335491072\" data-aria-label-part>{replies} replies</span> </span> </span> <span class=\"ProfileTweet-action--retweet u-hiddenVisually\"> <span class=\"ProfileTweet-actionCount\" aria-hidden=\"true\" data-tweet-stat-count=\"{retweets}\"> <span class=\"ProfileTweet-actionCountForAria\" id=\"profile-tweet-action-retweet-count-aria-1060774952335491072\">{retweets} retweets</span> </span> </span> <span class=\"ProfileTweet-action--favorite u-hiddenVisually\"> <span class=\"ProfileTweet-actionCount\" aria-hidden=\"true\" data-tweet-stat-count=\"{likes}\"> <span class=\"ProfileTweet-actionCountForAria\" id=\"profile-tweet-action-favorite-count-aria-1060774952335491072\">{likes} likes</span> </span> </span> </div> <div class=\"ProfileTweet-actionList js-actions\" role=\"group\" aria-label=\"tweetrepo actions\"> <div class=\"ProfileTweet-action ProfileTweet-action--reply\"> <button class=\"ProfileTweet-actionButton js-actionButton js-actionReply\" data-modal=\"ProfileTweet-reply\" type=\"button\" aria-describedby=\"profile-tweet-action-reply-count-aria-1060774952335491072\"> <div class=\"IconContainer js-tooltip\" title=\"Reply\"> <span class=\"Icon Icon--medium Icon--reply\"></span> <span class=\"u-hiddenVisually\">Reply</span> </div> <span class=\"ProfileTweet-actionCount \"> <span class=\"ProfileTweet-actionCountForPresentation\" aria-hidden=\"true\">2</span> </span> </button> </div> <div class=\"ProfileTweet-action ProfileTweet-action--retweet js-toggleState js-toggleRt\"> <button class=\"ProfileTweet-actionButton js-actionButton js-actionRetweet\" data-modal=\"ProfileTweet-retweet\" type=\"button\" aria-describedby=\"profile-tweet-action-retweet-count-aria-1060774952335491072\"> <div class=\"IconContainer js-tooltip\" title=\"Retweet\"> <span class=\"Icon Icon--medium Icon--retweet\"></span> <span class=\"u-hiddenVisually\">Retweet</span> </div> <span class=\"ProfileTweet-actionCount ProfileTweet-actionCount--isZero\"> <span class=\"ProfileTweet-actionCountForPresentation\" aria-hidden=\"true\"></span> </span> </button> <button class=\"ProfileTweet-actionButtonUndo js-actionButton js-actionRetweet\" data-modal=\"ProfileTweet-retweet\" type=\"button\"> <div class=\"IconContainer js-tooltip\" title=\"Undo retweet\"> <span class=\"Icon Icon--medium Icon--retweet\"></span> <span class=\"u-hiddenVisually\">Retweeted</span> </div> <span class=\"ProfileTweet-actionCount ProfileTweet-actionCount--isZero\"> <span class=\"ProfileTweet-actionCountForPresentation\" aria-hidden=\"true\"></span> </span> </button> </div> <div class=\"ProfileTweet-action ProfileTweet-action--favorite js-toggleState\"> <button class=\"ProfileTweet-actionButton js-actionButton js-actionFavorite\" type=\"button\" aria-describedby=\"profile-tweet-action-favorite-count-aria-1060774952335491072\"> <div class=\"IconContainer js-tooltip\" title=\"Like\"> <span role=\"presentation\" class=\"Icon Icon--heart Icon--medium\"></span> <div class=\"HeartAnimation\"></div> <span class=\"u-hiddenVisually\">Like</span> </div> <span class=\"ProfileTweet-actionCount ProfileTweet-actionCount--isZero\"> <span class=\"ProfileTweet-actionCountForPresentation\" aria-hidden=\"true\"></span> </span> </button> <button class=\"ProfileTweet-actionButtonUndo ProfileTweet-action--unfavorite u-linkClean js-actionButton js-actionFavorite\" type=\"button\"> <div class=\"IconContainer js-tooltip\" title=\"Undo like\"> <span role=\"presentation\" class=\"Icon Icon--heart Icon--medium\"></span> <div class=\"HeartAnimation\"></div> <span class=\"u-hiddenVisually\">Liked</span> </div> <span class=\"ProfileTweet-actionCount ProfileTweet-actionCount--isZero\"> <span class=\"ProfileTweet-actionCountForPresentation\" aria-hidden=\"true\"></span> </span> </button> </div> </div> </div> <div class=\"self-thread-context\"> Show this thread </div> <div class=\"self-thread-tweet-cta self-thread-head\"> <div class=\"mini-avatar-with-thread\"> <img class=\"avatar--circular size24\" src=\"https://pbs.twimg.com/profile_images/1035805630651658240/qszg1MQQ_normal.jpg\"> </div> <a href=\"/AJBenzStorm/status/1060774952335491072\" class=\"js-nav show-thread-link\">Show this thread</a> </div> </div> </div> </li>"


class ExtractorTestCase(unittest.TestCase):

    _facker: Faker

    def setUp(self):
        self._facker = Faker()
        self._extractor = Parser()

    def test_extract(self):
        html, expected_result = self._tweet_html()

        tweets = self._extractor.parse(html)
        self.assertEqual(1, len(tweets))

        tweet = tweets[0]
        self.assertIsInstance(tweet, Tweet)
        self.assertEqual(expected_result["likes"], tweet.likes)
        self.assertEqual(expected_result["replies"], tweet.replies)
        self.assertEqual(expected_result["retweets"], tweet.retweets)
        self.assertEqual(expected_result["text"], tweet.text)
        self.assertEqual(expected_result["hashtags"], tweet.hashtags)


        self.assertIsInstance(tweets[0].account, Account)
        self.assertEqual(expected_result["account"]["id"], tweets[0].account.id)
        self.assertEqual(expected_result["account"]["fullname"], tweets[0].account.fullname)
        self.assertEqual(expected_result["account"]["href"], tweets[0].account.href)

    def _tweet_html(self):
        expected_results = {
            "account": {
                "id": self._facker.pyint(),
                "fullname": self._facker.name(),
                "href": '/' + self._facker.pystr(max_chars=10)
            },
            'date': '10:03 PM - 8 Nov 2018',
            "likes": self._facker.pyint(),
            "retweets": self._facker.pyint(),
            "replies": self._facker.pyint(),
            "text": "mr robot Yes Thanks #PrimeVideo #Amazon #thatsgeniuspic.twitter.com/sDqLNZDPNY",
            "hashtags": ['#PrimeVideo', '#Amazon', '#thatsgenius']
        }

        return tweet_template.format(**expected_results), expected_results


